import{c as v,r as c,j as e,k as Z,X as G,e as ge,s as o,L as A}from"./index-C1rFkvFB.js";import{A as pe}from"./arrow-left-XJw2b7Ao.js";import{T as B}from"./tag-B6XER0A3.js";import{P as fe}from"./plus-BLl9o80y.js";import{F as ye}from"./flame-rD-PEHFx.js";import{C as be}from"./check-C5qKksiE.js";import{S as ve}from"./send-CiEkxT-W.js";const je=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],J=v("archive",je);const we=[["path",{d:"M12 18V5",key:"adv99a"}],["path",{d:"M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4",key:"1e3is1"}],["path",{d:"M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5",key:"1gqd8o"}],["path",{d:"M17.997 5.125a4 4 0 0 1 2.526 5.77",key:"iwvgf7"}],["path",{d:"M18 18a4 4 0 0 0 2-7.464",key:"efp6ie"}],["path",{d:"M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517",key:"1gq6am"}],["path",{d:"M6 18a4 4 0 0 1-2-7.464",key:"k1g0md"}],["path",{d:"M6.003 5.125a4 4 0 0 0-2.526 5.77",key:"q97ue3"}]],Ne=v("brain",we);const _e=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ke=v("eye-off",_e);const Se=[["path",{d:"M4 22V4a1 1 0 0 1 .4-.8A6 6 0 0 1 8 2c3 0 5 2 7.333 2q2 0 3.067-.8A1 1 0 0 1 20 4v10a1 1 0 0 1-.4.8A6 6 0 0 1 16 16c-3 0-5-2-8-2a6 6 0 0 0-4 1.528",key:"1jaruq"}]],Te=v("flag",Se);const Ce=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],Me=v("heart",Ce);const Re=[["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}],["path",{d:"M7 10v12",key:"1qc93n"}]],$e=v("thumbs-up",Re);function Ae(d){return d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function Q(d){let s=Ae(d);return s=s.replace(/`([^`]+)`/g,'<code class="bg-[#111] px-1.5 py-0.5 rounded text-xs font-mono text-gray-200">$1</code>'),s=s.replace(/\*\*([^*]+)\*\*/g,'<strong class="font-semibold text-white">$1</strong>'),s=s.replace(/\*([^*]+)\*/g,'<em class="italic">$1</em>'),s=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="text-[#a6ed2a] hover:underline">$1</a>'),s=s.replace(/(^|[\s>])((https?:\/\/)[^\s<]+)/g,'$1<a href="$2" target="_blank" rel="noopener noreferrer" class="text-[#a6ed2a] hover:underline">$2</a>'),s}function qe({content:d}){const s=c.useMemo(()=>{const n=[],m=d.split(/```(\w*)\n?([\s\S]*?)```/);for(let h=0;h<m.length;h++)h%3===0?m[h]&&n.push({type:"text",content:m[h]}):h%3===1||n.push({type:"code",content:m[h],lang:m[h-1]||void 0});return n},[d]);return e.jsx("div",{className:"text-sm text-gray-300 space-y-2",children:s.map((n,m)=>{if(n.type==="code")return e.jsx("pre",{className:"bg-[#111] rounded-lg p-3 overflow-x-auto text-xs font-mono text-gray-200 border border-[#1d2839]",children:e.jsx("code",{children:n.content})},m);const h=n.content.split(`
`),x=[];let p=[];const f=()=>{p.length>0&&(x.push(e.jsx("ul",{className:"list-disc list-inside space-y-0.5 pl-2",children:p.map((y,g)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:Q(y)}},g))},`list-${x.length}`)),p=[])};for(const y of h){const g=y.match(/^[\s]*[-*]\s+(.+)/);if(g)p.push(g[1]);else{f();const u=y.trim();u&&x.push(e.jsx("p",{dangerouslySetInnerHTML:{__html:Q(u)}},`p-${x.length}`))}}return f(),e.jsx("div",{children:x},m)})})}const U=["Consensus reached","Question answered","Action items identified","Decision made","Information gathered","Other"];function Ee({threadTitle:d,onResolve:s,onClose:n}){const[m,h]=c.useState(U[0]),[x,p]=c.useState(""),[f,y]=c.useState(!1);async function g(){x.trim()&&(y(!0),s({reason:m,summary:x.trim()}))}return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",onClick:n,children:e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-xl p-6 w-full max-w-md",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5 text-[#a78bfa]"}),e.jsx("h2",{className:"text-lg font-bold",children:"Resolve Thread"})]}),e.jsx("button",{onClick:n,className:"text-gray-400 hover:text-white",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("p",{className:"text-sm text-gray-400 mb-4",children:["Resolving: ",e.jsx("span",{className:"text-white",children:d})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Reason"}),e.jsx("select",{value:m,onChange:u=>h(u.target.value),className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-[#a78bfa]",children:U.map(u=>e.jsx("option",{value:u,children:u},u))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Resolution Summary"}),e.jsx("textarea",{value:x,onChange:u=>p(u.target.value),placeholder:"Summarize the resolution or key takeaways...",rows:4,className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-[#a78bfa] text-sm resize-none"})]}),e.jsx("button",{onClick:g,disabled:!x.trim()||f,className:"w-full bg-[#a78bfa] text-white font-medium py-2 rounded-lg hover:bg-[#c4b5fd] transition-colors text-sm disabled:opacity-50",children:f?"Resolving...":"Resolve Thread"})]})]})})}const X=[{emoji:"thumbsup",icon:$e,label:"Thumbs up"},{emoji:"heart",icon:Me,label:"Heart"},{emoji:"fire",icon:ye,label:"Fire"},{emoji:"thinking",icon:Ne,label:"Thinking"},{emoji:"check",icon:be,label:"Check"}];function Le(d){const s=Math.floor((Date.now()-new Date(d).getTime())/1e3);return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:`${Math.floor(s/86400)}d ago`}function ze(){const{slug:d,threadId:s}=ge(),[n,m]=c.useState(null),[h,x]=c.useState(null),[p,f]=c.useState([]),[y,g]=c.useState([]),[u,W]=c.useState(!0),[l,q]=c.useState(null),[N,E]=c.useState(""),[Y,L]=c.useState(!1),[D,_]=c.useState(null),[k,ee]=c.useState([]),[j,I]=c.useState(!1),[O,te]=c.useState([]),[S,H]=c.useState(""),[T,se]=c.useState("custom"),[ae,C]=c.useState(!1),V=c.useRef(null);c.useEffect(()=>{o.auth.getSession().then(({data:a})=>q(a.session));const{data:{subscription:t}}=o.auth.onAuthStateChange((a,r)=>q(r));return()=>t.unsubscribe()},[]),c.useEffect(()=>{s&&d&&w()},[s,d]),c.useEffect(()=>{if(!s)return;const t=o.channel(`thread-${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`thread_id=eq.${s}`},r=>{f(i=>[...i,r.new])}).subscribe(),a=o.channel(`reactions-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},()=>{F()}).subscribe();return()=>{o.removeChannel(t),o.removeChannel(a)}},[s]),c.useEffect(()=>{V.current?.scrollIntoView({behavior:"smooth"})},[p]);async function w(){const{data:t}=await o.from("channels").select("slug, name").eq("slug",d).single();x(t);const{data:a}=await o.from("threads").select("*").eq("id",s).single();m(a);const{data:r}=await o.from("messages").select("*").eq("thread_id",s).order("created_at",{ascending:!0});f(r||[]),await F(),await M(),W(!1)}async function M(){if(!s)return;const{data:t}=await o.from("thread_tags").select("*").eq("thread_id",s).order("created_at",{ascending:!0});ee(t||[])}async function re(){if(!s)return;const{data:t,error:a}=await o.rpc("suggest_thread_tags",{p_thread_id:s});!a&&t&&te(t)}async function R(t,a){if(!s||!l||!a.trim())return;const{error:r}=await o.rpc("add_thread_tag",{p_thread_id:s,p_tag_type:t,p_tag_value:a.trim(),p_participant_id:l.user.id});r||(await M(),H(""),I(!1))}async function ne(t){const{error:a}=await o.from("thread_tags").delete().eq("id",t);a||await M()}async function ie(){if(!s||!l||!n)return;if(n.status!=="open"){alert("Only open threads can be tagged");return}const{error:t}=await o.from("threads").update({status:"tagged"}).eq("id",s);t||await w()}async function oe(t){if(!s||!l||!n)return;if(n.status!=="tagged"){alert("Thread must be tagged before resolving");return}t?.summary&&await o.from("messages").insert({thread_id:s,author_id:l.user.id,content:`**Resolved:** ${t.reason}

${t.summary}`,type:"system"});const{error:a}=await o.from("threads").update({status:"resolved"}).eq("id",s);a||(C(!1),await w())}async function ce(){if(!s||!l)return;const{error:t}=await o.rpc("archive_thread",{p_thread_id:s});t||await w()}async function le(){if(!s||!l||!n)return;if(n.status!=="resolved"){alert("Thread must be resolved before consolidating");return}const{data:t,error:a}=await o.rpc("consolidate_thread",{p_thread_id:s});!a&&t?(alert(`Artifact created: ${t}`),await w()):a&&alert(`Error: ${a.message}`)}async function de(t){if(!l)return;const a=prompt("Reason for reporting:");a&&(await o.rpc("report_message",{p_message_id:t,p_reporter_id:l.user.id,p_reason:a}),alert("Message reported"))}async function he(t){l&&(await o.rpc("moderate_hide_message",{p_message_id:t,p_moderator_id:l.user.id,p_reason:"Hidden by moderator"}),f(a=>a.map(r=>r.id===t?{...r,hidden:!0}:r)))}async function F(){if(!s)return;const{data:t}=await o.from("messages").select("id").eq("thread_id",s);if(!t||t.length===0){g([]);return}const{data:a}=await o.from("message_reactions").select("*").in("message_id",t.map(r=>r.id));g(a||[])}async function P(){!N.trim()||!l||!s||(L(!0),await o.from("messages").insert({thread_id:s,author_id:l.user.id,content:N.trim(),type:"text"}),E(""),L(!1))}async function z(t,a){if(!l)return;const r=y.find(i=>i.message_id===t&&i.participant_id===l.user.id&&i.emoji===a);if(r)await o.from("message_reactions").delete().eq("id",r.id),g(i=>i.filter(b=>b.id!==r.id));else{const{data:i}=await o.from("message_reactions").insert({message_id:t,participant_id:l.user.id,emoji:a}).select().single();i&&g(b=>[...b,i])}_(null)}function ue(t){const a=y.filter(i=>i.message_id===t),r={};for(const i of a)r[i.emoji]||(r[i.emoji]={count:0,hasOwn:!1}),r[i.emoji].count++,l&&i.participant_id===l.user.id&&(r[i.emoji].hasOwn=!0);return r}return u?e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Loading..."}):!n||!h?e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Thread not found"}):e.jsxs("div",{className:"flex flex-col h-[calc(100vh-10rem)]",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-shrink-0",children:[e.jsx(A,{to:`/channels/${d}`,className:"text-gray-400 hover:text-white",children:e.jsx(pe,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-lg font-bold",children:n.title}),e.jsxs(A,{to:`/channels/${d}`,className:"text-xs text-gray-500 hover:text-[#a6ed2a]",children:["#",h.name]})]}),l&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{I(!j),j||re()},className:"text-gray-400 hover:text-white",title:"Manage tags",children:e.jsx(B,{className:"w-5 h-5"})}),n.status==="open"&&k.length>0&&e.jsx("button",{onClick:ie,className:"text-gray-400 hover:text-[#60a5fa] transition-colors",title:"Mark as tagged",children:e.jsx(B,{className:"w-5 h-5 fill-current"})}),n.status==="tagged"&&e.jsx("button",{onClick:()=>C(!0),className:"text-gray-400 hover:text-[#a78bfa] transition-colors",title:"Resolve thread",children:e.jsx(Z,{className:"w-5 h-5"})}),n.status==="resolved"&&e.jsx("button",{onClick:le,className:"text-gray-400 hover:text-[#fb923c] transition-colors",title:"Consolidate into artifact",children:e.jsx(J,{className:"w-5 h-5"})}),n.status!=="archived"&&e.jsx("button",{onClick:ce,className:"text-gray-400 hover:text-gray-500 transition-colors",title:"Archive thread",children:e.jsx(J,{className:"w-4 h-4"})})]})]}),(k.length>0||j)&&e.jsxs("div",{className:"mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[k.map(t=>e.jsxs("div",{className:"flex items-center gap-1 bg-[#0a101d] border border-[#1d2839] rounded-md px-2 py-1 text-xs",children:[e.jsx("span",{className:"text-gray-400",children:t.tag_value}),l&&t.created_by===l.user.id&&e.jsx("button",{onClick:()=>ne(t.id),className:"text-gray-600 hover:text-red-400",children:e.jsx(G,{className:"w-3 h-3"})})]},t.id)),j&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("select",{value:T,onChange:t=>se(t.target.value),className:"bg-[#080c16] border border-[#1d2839] rounded-md px-2 py-1 text-xs text-white",children:[e.jsx("option",{value:"dimension",children:"Dimension"}),e.jsx("option",{value:"topic",children:"Topic"}),e.jsx("option",{value:"artifact_type",children:"Artifact Type"}),e.jsx("option",{value:"custom",children:"Custom"})]}),e.jsx("input",{value:S,onChange:t=>H(t.target.value),onKeyDown:t=>t.key==="Enter"&&R(T,S),placeholder:"Tag value...",className:"bg-[#080c16] border border-[#1d2839] rounded-md px-2 py-1 text-xs text-white placeholder-gray-600"}),e.jsx("button",{onClick:()=>R(T,S),className:"bg-[#a6ed2a] text-[#080c16] rounded-md p-1",children:e.jsx(fe,{className:"w-4 h-4"})})]})]}),j&&O.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-[#1d2839]",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Suggested:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:O.slice(0,5).map((t,a)=>e.jsx("button",{onClick:()=>R(t.tag_type,t.tag_value),className:"text-xs px-2 py-1 rounded-md bg-[#080c16] text-gray-400 border border-[#1d2839] hover:border-[#a6ed2a] hover:text-white transition-colors",children:t.tag_value},a))})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 mb-4",children:[p.length===0?e.jsx("div",{className:"text-center text-gray-500 py-12 text-sm",children:"No messages yet. Start the conversation!"}):p.map(t=>{const a=t.type==="system",r=ue(t.id);return e.jsx("div",{className:`group relative ${a?"text-center":""}`,onMouseLeave:()=>_(null),children:a?e.jsx("div",{className:"inline-block bg-[#1d2839] rounded-lg px-4 py-2 text-xs text-gray-400 italic",children:t.content}):t.hidden?e.jsx("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-2 opacity-50",children:e.jsx("span",{className:"text-xs text-gray-500 italic",children:"Message hidden by moderator"})}):e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-white",children:t.author_id?t.author_id.slice(0,8):"Anonymous"}),e.jsx("span",{className:"text-xs text-gray-600",children:Le(t.created_at)}),l&&e.jsxs("div",{className:"ml-auto flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:()=>_(D===t.id?null:t.id),className:"text-gray-600 hover:text-gray-400 text-xs",children:"+"}),e.jsx("button",{onClick:()=>de(t.id),className:"text-gray-600 hover:text-red-400 text-xs",title:"Report",children:e.jsx(Te,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>he(t.id),className:"text-gray-600 hover:text-yellow-400 text-xs",title:"Hide",children:e.jsx(ke,{className:"w-3 h-3"})})]})]}),e.jsx(qe,{content:t.content}),Object.keys(r).length>0&&e.jsx("div",{className:"flex gap-1.5 mt-2 flex-wrap",children:Object.entries(r).map(([i,{count:b,hasOwn:$}])=>{const K=X.find(xe=>xe.emoji===i);if(!K)return null;const me=K.icon;return e.jsxs("button",{onClick:()=>z(t.id,i),className:`flex items-center gap-1 px-2 py-0.5 rounded-full text-xs border transition-colors ${$?"border-[#a6ed2a]/40 bg-[#a6ed2a]/10 text-[#a6ed2a]":"border-[#1d2839] bg-[#1d2839]/50 text-gray-400 hover:border-gray-500"}`,children:[e.jsx(me,{className:"w-3 h-3"}),b]},i)})}),D===t.id&&e.jsx("div",{className:"flex gap-1 mt-2 bg-[#1d2839] rounded-lg p-1.5 w-fit",children:X.map(({emoji:i,icon:b,label:$})=>e.jsx("button",{onClick:()=>z(t.id,i),title:$,className:"p-1.5 rounded hover:bg-[#333] text-gray-400 hover:text-white transition-colors",children:e.jsx(b,{className:"w-4 h-4"})},i))})]})},t.id)}),e.jsx("div",{ref:V})]}),l?e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx("input",{value:N,onChange:t=>E(t.target.value),onKeyDown:t=>t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),P()),placeholder:"Type a message...",className:"flex-1 bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:border-[#a6ed2a] text-sm"}),e.jsx("button",{onClick:P,disabled:!N.trim()||Y,className:"bg-[#a6ed2a] text-[#080c16] px-4 py-2.5 rounded-lg hover:bg-[#b8f247] transition-colors disabled:opacity-50",children:e.jsx(ve,{className:"w-4 h-4"})})]}):e.jsxs("div",{className:"text-center py-3 text-sm text-gray-500",children:[e.jsx(A,{to:"/auth",className:"text-[#a6ed2a] hover:text-white",children:"Sign in"})," to send messages"]}),ae&&n&&e.jsx(Ee,{threadTitle:n.title,onResolve:oe,onClose:()=>C(!1)})]})}export{ze as ThreadView};
