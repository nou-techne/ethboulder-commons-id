import{c as V,e as X,r as o,s as i,j as e,L as z,X as G}from"./index-DMonaj-y.js";import{E as K}from"./EmptyState-BaUrHS-t.js";import{A as Q}from"./arrow-left-BBDwytvA.js";import{H as W}from"./hash-D2O0A6Fo.js";import{P as Y}from"./plus-BEFdCwWv.js";import{M as O}from"./message-square-BWqwvPd2.js";import{C as Z}from"./check-CARfCKV0.js";const ee=[["path",{d:"m8 6 4-4 4 4",key:"ybng9g"}],["path",{d:"M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22",key:"1hyw0i"}],["path",{d:"m20 22-5-5",key:"1m27yz"}]],D=V("merge",ee),F={open:"#a6ed2a",tagged:"#60a5fa",resolved:"#a78bfa",consolidated:"#fb923c",archived:"#9ca3af"},P={open:"Open",tagged:"Tagged",resolved:"Resolved",consolidated:"Consolidated",archived:"Archived"};function te(c){const r=Math.floor((Date.now()-new Date(c).getTime())/1e3);return r<60?`${r}s ago`:r<3600?`${Math.floor(r/60)}m ago`:r<86400?`${Math.floor(r/3600)}h ago`:`${Math.floor(r/86400)}d ago`}function ce(){const{slug:c}=X(),[r,R]=o.useState(null),[x,q]=o.useState([]),[I,S]=o.useState(!0),[m,C]=o.useState(null),[H,h]=o.useState(!1),[g,_]=o.useState(""),[p,k]=o.useState(""),[T,M]=o.useState(!1),[b,J]=o.useState("all"),[u,j]=o.useState(!1),[d,v]=o.useState(new Set),[A,$]=o.useState(!1);o.useEffect(()=>{i.auth.getSession().then(({data:t})=>C(t.session));const{data:{subscription:s}}=i.auth.onAuthStateChange((t,a)=>C(a));return()=>s.unsubscribe()},[]),o.useEffect(()=>{c&&w()},[c]);async function w(){const{data:s}=await i.from("channels").select("*").eq("slug",c).single();if(!s){S(!1);return}R(s);const{data:t}=await i.from("threads").select("*").eq("channel_id",s.id).order("updated_at",{ascending:!1}),a=t||[];if(a.length>0){const{data:l}=await i.from("messages").select("thread_id").in("thread_id",a.map(n=>n.id)),N={};if(l)for(const n of l)N[n.thread_id]=(N[n.thread_id]||0)+1;const{data:E}=await i.from("thread_tags").select("*").in("thread_id",a.map(n=>n.id)),f={};if(E)for(const n of E){const y=n.thread_id;f[y]||(f[y]=[]),f[y].push(n)}for(const n of a)n.message_count=N[n.id]||0,n.tags=f[n.id]||[]}if(q(a),c){const l=JSON.parse(localStorage.getItem("channel_last_read")||"{}");l[c]=new Date().toISOString(),localStorage.setItem("channel_last_read",JSON.stringify(l))}S(!1)}async function U(){if(!g.trim()||!m||!r)return;M(!0);const{data:s,error:t}=await i.from("threads").insert({channel_id:r.id,title:g.trim(),status:"open",created_by:m.user.id}).select().single();!t&&s&&p.trim()&&await i.from("messages").insert({thread_id:s.id,author_id:m.user.id,content:p.trim(),type:"text"}),t||(_(""),k(""),h(!1),await w()),M(!1)}function L(s){v(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})}async function B(){if(d.size<2)return;$(!0);const{data:s,error:t}=await i.rpc("consolidate_threads",{p_thread_ids:Array.from(d)});!t&&s?(j(!1),v(new Set),await w()):t&&alert(`Error: ${t.message}`),$(!1)}return I?e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Loading..."}):r?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(z,{to:"/channels",className:"text-gray-400 hover:text-white",children:e.jsx(Q,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5 text-gray-500"}),e.jsx("h1",{className:"text-2xl font-bold",children:r.name})]}),r.description&&e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:r.description})]}),m&&e.jsx("div",{className:"flex gap-2",children:u?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:B,disabled:d.size<2||A,className:"flex items-center gap-2 bg-[#fb923c] text-[#080c16] font-medium px-4 py-2 rounded-lg hover:bg-[#fdba74] transition-colors text-sm disabled:opacity-50",children:[e.jsx(D,{className:"w-4 h-4"}),A?"Merging...":`Merge ${d.size} threads`]}),e.jsx("button",{onClick:()=>{j(!1),v(new Set)},className:"text-gray-400 hover:text-white px-3 py-2 text-sm",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[x.some(s=>s.status==="resolved")&&e.jsxs("button",{onClick:()=>j(!0),className:"flex items-center gap-2 bg-[#0a101d] border border-[#1d2839] text-gray-400 font-medium px-4 py-2 rounded-lg hover:text-white hover:border-[#fb923c] transition-colors text-sm",children:[e.jsx(D,{className:"w-4 h-4"}),"Consolidate"]}),e.jsxs("button",{onClick:()=>h(!0),className:"flex items-center gap-2 bg-[#a6ed2a] text-[#080c16] font-medium px-4 py-2 rounded-lg hover:bg-[#b8f247] transition-colors text-sm",children:[e.jsx(Y,{className:"w-4 h-4"}),"New Thread"]})]})})]}),e.jsx("div",{className:"flex gap-1 mb-4 overflow-x-auto pb-1",children:["all","open","tagged","resolved","archived"].map(s=>{const t=s==="all"?x.filter(l=>l.status!=="archived").length:x.filter(l=>l.status===s).length,a=b===s;return e.jsxs("button",{onClick:()=>J(s),className:`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-colors ${a?"bg-[#a6ed2a] text-[#080c16]":"bg-[#0a101d] text-gray-400 hover:text-white border border-[#1d2839]"}`,children:[s==="all"?"All":P[s]," (",t,")"]},s)})}),H&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",onClick:()=>h(!1),children:e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-xl p-6 w-full max-w-md",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold",children:"New Thread"}),e.jsx("button",{onClick:()=>h(!1),className:"text-gray-400 hover:text-white",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Title"}),e.jsx("input",{value:g,onChange:s=>_(s.target.value),placeholder:"Thread title",className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-[#a6ed2a] text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"First message (optional)"}),e.jsx("textarea",{value:p,onChange:s=>k(s.target.value),placeholder:"Start the conversation...",rows:3,className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-[#a6ed2a] text-sm resize-none"})]}),e.jsx("button",{onClick:U,disabled:!g.trim()||T,className:"w-full bg-[#a6ed2a] text-[#080c16] font-medium py-2 rounded-lg hover:bg-[#b8f247] transition-colors text-sm disabled:opacity-50",children:T?"Creating...":"Create Thread"})]})]})}),(()=>{const s=b==="all"?x.filter(t=>t.status!=="archived"):x.filter(t=>t.status===b);return s.length===0?e.jsx(K,{icon:e.jsx(O,{className:"w-12 h-12"}),title:"No threads yet",description:"Start a thread to begin the conversation.",action:m?{label:"Create Thread",onClick:()=>h(!0)}:void 0}):e.jsx("div",{className:"space-y-2",children:s.map(t=>e.jsxs("div",{className:"flex items-center gap-3",children:[u&&t.status==="resolved"&&e.jsx("button",{onClick:()=>L(t.id),className:`w-5 h-5 rounded border-2 flex-shrink-0 flex items-center justify-center transition-colors ${d.has(t.id)?"bg-[#fb923c] border-[#fb923c]":"border-[#1d2839] hover:border-[#fb923c]"}`,children:d.has(t.id)&&e.jsx(Z,{className:"w-3 h-3 text-[#080c16]"})}),e.jsx(z,{to:u?"#":`/channels/${c}/${t.id}`,onClick:u?a=>{a.preventDefault(),t.status==="resolved"&&L(t.id)}:void 0,className:`flex-1 flex items-center gap-3 bg-[#0a101d] border rounded-lg px-4 py-3 hover:border-[#a6ed2a] transition-colors group ${d.has(t.id)?"border-[#fb923c]":"border-[#1d2839]"}`,children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-white text-sm group-hover:text-[#a6ed2a] transition-colors",children:t.title}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full font-medium",style:{backgroundColor:F[t.status]+"20",color:F[t.status]},children:P[t.status]})]}),t.tags&&t.tags.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1 mb-1",children:[t.tags.slice(0,4).map(a=>e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-md bg-[#080c16] text-gray-400 border border-[#1d2839]",children:a.tag_value},a.id)),t.tags.length>4&&e.jsxs("span",{className:"text-xs px-2 py-0.5 text-gray-500",children:["+",t.tags.length-4]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(O,{className:"w-3 h-3"}),t.message_count||0]}),e.jsx("span",{children:te(t.updated_at)})]})]})})]},t.id))})})()]}):e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Channel not found"})}export{ce as ChannelView};
