import{c as $,e as J,r,s as i,j as e,L as u,A as V,R as K,a as L,b as Q,d as R}from"./index-CBgAWxJw.js";import{C as T}from"./chevron-right-ChBaX1-d.js";import{C as X}from"./clock-qkWA5Amp.js";import{U as W}from"./user-CmBkjQE0.js";import{S as Z}from"./send-BcsSUfK8.js";const ee=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],b=$("loader-circle",ee);const te=[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]],M=$("message-circle",te),se=[{key:"e",letter:"e/",name:"Ecology",desc:"Where We Are",color:"#4a8c6f",tag:"hlamt:E"},{key:"H",letter:"H/",name:"Human",desc:"Who's Here",color:"#c4956a",tag:"hlamt:H"},{key:"L",letter:"L/",name:"Language",desc:"How We Talk",color:"#a6ed2a",tag:"hlamt:L"},{key:"A",letter:"A/",name:"Artifacts",desc:"What We're Building",color:"#8bbfff",tag:"hlamt:A"},{key:"M",letter:"M/",name:"Methodology",desc:"How We Work",color:"#7ccfb8",tag:"hlamt:M"},{key:"T",letter:"T/",name:"Training",desc:"What We're Learning",color:"#e8927c",tag:"hlamt:T"}];function F(o){const s=Math.floor((Date.now()-new Date(o).getTime())/1e3);return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:`${Math.floor(s/86400)}d ago`}function le(){const{id:o}=J(),[s,H]=r.useState(null),[v,O]=r.useState([]),[D,P]=r.useState({}),[B,f]=r.useState(!0),[_,q]=r.useState(null),[I,S]=r.useState(!1),[h,z]=r.useState([]),[G,y]=r.useState(!1),[p,j]=r.useState(""),[N,C]=r.useState(!1),[g,U]=r.useState(null);r.useEffect(()=>{o&&k(o),i.auth.getSession().then(({data:{session:t}})=>{U(t)})},[o]);async function k(t){f(!0);const{data:a}=await i.from("contributions").select("*").eq("id",t).single();if(!a){f(!1);return}if(H(a),a.participant_id){const{data:l}=await i.from("participants").select("name").eq("id",a.participant_id).single();l&&q(l.name)}const n=[];if(a.extraction?.artifacts&&a.processed_at){const l=a.extraction.artifacts.map(c=>c.title).filter(Boolean);if(l.length>0){const{data:c}=await i.from("artifacts").select("*").in("title",l).order("created_at",{ascending:!1});c&&n.push(...c)}}if(O(n),n.length>0){const l=n.map(x=>x.id),{data:c}=await i.from("artifact_tags").select("tag_id, tags(name)").in("artifact_id",l),m={};if(c)for(const x of c){const w=x.tags?.name;w?.startsWith("hlamt:")&&(m[w]=(m[w]||0)+1)}const A=n.filter(x=>x.rea_role==="agent").length;A>0&&(m["hlamt:H"]=(m["hlamt:H"]||0)+A),P(m)}const{data:d}=await i.rpc("get_contribution_thread",{p_contribution_id:t});d&&d.length>1&&z(d.slice(1)),f(!1)}async function Y(t){if(t.preventDefault(),!(!p.trim()||!g)){C(!0);try{const{data:a}=await i.from("participants").select("id").eq("auth_user_id",g.user.id).single(),{error:n}=await i.from("contributions").insert({content:p.trim(),participant_id:a?.id,parent_contribution_id:o,convergence_id:s?.extraction?.convergence_id||null,status:"pending"});if(n)throw n;j(""),y(!1),o&&await k(o)}catch(a){console.error("Reply submit error:",a),alert("Failed to submit reply. Please try again.")}finally{C(!1)}}}if(B)return e.jsx("div",{className:"text-center py-12",children:e.jsx(b,{className:"w-8 h-8 text-gray-500 mx-auto animate-spin"})});if(!s)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-400",children:"Contribution not found"}),e.jsx(u,{to:"/",className:"text-[#a6ed2a] hover:text-white text-sm mt-2 inline-block",children:"Back to Explore"})]});const E=v.length>0;return e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("nav",{className:"flex items-center gap-1.5 text-sm mb-6",children:[e.jsx(u,{to:"/",className:"text-gray-400 hover:text-white transition-colors",children:"Explore"}),e.jsx(T,{className:"w-3.5 h-3.5 text-gray-600"}),e.jsx("span",{className:"text-gray-400",children:"Live Activity"}),e.jsx(T,{className:"w-3.5 h-3.5 text-gray-600"}),e.jsx("span",{className:"text-white",children:"Contribution"})]}),e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${s.status==="complete"?"bg-[#a6ed2a]":s.status==="processing"?"bg-blue-400 animate-pulse":s.status==="error"?"bg-red-400":"bg-yellow-400"}`}),e.jsx("span",{className:"text-sm text-gray-400 capitalize",children:s.status}),e.jsx("span",{className:"text-gray-600",children:"|"}),e.jsx(X,{className:"w-3.5 h-3.5 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-400",children:F(s.created_at)}),_&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-600",children:"|"}),e.jsx(W,{className:"w-3.5 h-3.5 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-400",children:_})]})]}),e.jsx("div",{className:"text-gray-200 whitespace-pre-wrap leading-relaxed",children:s.content.length>300&&!I?e.jsxs(e.Fragment,{children:[s.content.slice(0,300).trimEnd(),"...",e.jsx("button",{onClick:()=>S(!0),className:"ml-2 text-[#a6ed2a] hover:text-white text-sm font-medium",children:"View more"})]}):e.jsxs(e.Fragment,{children:[s.content,s.content.length>300&&e.jsx("button",{onClick:()=>S(!1),className:"ml-2 text-[#a6ed2a] hover:text-white text-sm font-medium",children:"Show less"})]})})]}),E&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Observation Dimensions"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-6 gap-2 mb-6",children:se.map(t=>{const a=D[t.tag]??0,n=a>0?u:"div",d=a>0?{to:`/d/${t.key}`}:{};return e.jsxs(n,{...d,className:`rounded-lg border border-[#1d2839] bg-[#0a101d] p-3 sm:p-4 text-center block transition-all ${a>0?"border-opacity-100 hover:scale-105 hover:shadow-lg cursor-pointer":"opacity-40"}`,style:a>0?{borderColor:t.color+"40"}:void 0,children:[e.jsx("div",{className:"text-xs font-medium mb-1 truncate",style:{color:t.color},children:t.name}),e.jsxs("div",{className:"flex items-baseline justify-center gap-1 sm:gap-1.5",children:[e.jsx("span",{className:"font-mono text-xl sm:text-2xl font-bold",style:{color:t.color},children:t.letter}),e.jsx("span",{className:"text-xl sm:text-2xl font-bold text-white",children:a})]}),e.jsx("span",{className:"text-xs text-gray-400 block truncate",children:t.desc})]},t.key)})})]}),E&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Extracted Artifacts"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-6",children:v.map(t=>e.jsxs(u,{to:`/artifact/${t.id}`,className:"block bg-[#0a101d] border border-[#1d2839] rounded-xl p-4 hover:border-[#a6ed2a] transition-colors group",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"inline-block w-2.5 h-2.5 rounded-full",style:{backgroundColor:V[t.type]}}),e.jsx("span",{className:"text-xs uppercase tracking-wider text-gray-400",children:t.type}),t.rea_role&&e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded border",style:{color:L[t.rea_role],borderColor:L[t.rea_role]+"40"},children:K[t.rea_role]}),t.agent_type&&e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded border",style:{color:R[t.agent_type],borderColor:R[t.agent_type]+"40"},children:Q[t.agent_type]})]}),e.jsx("h3",{className:"font-semibold text-white group-hover:text-[#a6ed2a] transition-colors mb-1 text-sm",children:t.title}),t.summary&&e.jsx("p",{className:"text-xs text-gray-400 line-clamp-2",children:t.summary})]},t.id))})]}),s.status==="processing"&&e.jsxs("div",{className:"bg-[#0a101d] border border-blue-500/20 rounded-lg p-6 text-center",children:[e.jsx(b,{className:"w-8 h-8 text-blue-400 mx-auto mb-3 animate-spin"}),e.jsx("p",{className:"text-gray-300",children:"Extracting knowledge from this contribution..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Artifacts will appear here when processing completes."})]}),s.status==="error"&&e.jsxs("div",{className:"bg-[#0a101d] border border-red-500/20 rounded-lg p-6",children:[e.jsx("p",{className:"text-red-400 mb-2",children:"Extraction failed"}),s.errors&&e.jsx("pre",{className:"text-xs text-gray-500 overflow-x-auto",children:JSON.stringify(s.errors,null,2)})]}),s.status==="pending"&&e.jsx("div",{className:"bg-[#0a101d] border border-yellow-500/20 rounded-lg p-6 text-center",children:e.jsx("p",{className:"text-yellow-400",children:"Waiting to be processed..."})}),h.length>0&&e.jsxs("div",{className:"mt-6 border-t border-[#1d2839] pt-6",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5 text-[#a6ed2a]"}),h.length," ",h.length===1?"Reply":"Replies"]}),e.jsx("div",{className:"space-y-3",children:h.map(t=>e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg p-4",style:{marginLeft:`${t.depth*20}px`},children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx(W,{className:"w-4 h-4"}),e.jsx("span",{children:t.participant_name||"Anonymous"}),e.jsx("span",{className:"text-gray-600",children:"Â·"}),e.jsx("span",{children:F(t.created_at)})]}),t.status==="processing"&&e.jsx(b,{className:"w-4 h-4 text-blue-400 animate-spin"})]}),e.jsx("p",{className:"text-gray-300 text-sm whitespace-pre-wrap",children:t.content})]},t.id))})]}),e.jsx("div",{className:"mt-6 border-t border-[#1d2839] pt-6",children:G?e.jsxs("form",{onSubmit:Y,className:"space-y-3",children:[e.jsx("textarea",{value:p,onChange:t=>j(t.target.value),placeholder:"Share your thoughts, questions, or build on this contribution...",rows:4,autoFocus:!0,className:"w-full bg-[#080c16] border border-[#283347] rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-[#a6ed2a] transition-colors resize-none"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"submit",disabled:!p.trim()||N,className:"flex items-center gap-2 px-4 py-2 bg-[#a6ed2a] text-[#080c16] font-medium rounded-lg hover:bg-[#b8f247] transition-colors disabled:opacity-50 text-sm",children:[N?e.jsx(b,{className:"w-4 h-4 animate-spin"}):e.jsx(Z,{className:"w-4 h-4"}),N?"Submitting...":"Submit Reply"]}),e.jsx("button",{type:"button",onClick:()=>{y(!1),j("")},className:"px-4 py-2 bg-[#1d2839] text-white rounded-lg hover:bg-[#283347] transition-colors text-sm",children:"Cancel"})]})]}):e.jsxs("button",{onClick:()=>y(!0),disabled:!g,className:"flex items-center gap-2 px-4 py-2 bg-[#0a101d] border border-[#1d2839] rounded-lg hover:border-[#a6ed2a] transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(M,{className:"w-4 h-4"}),g?"Reply to this contribution":"Sign in to reply"]})})]})}export{le as ContributionDetail};
