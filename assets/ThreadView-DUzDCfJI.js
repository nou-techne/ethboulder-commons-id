import{c as v,r as i,j as e,k as se,X as ae,e as _e,s as o,L as q}from"./index-sqjsVm1m.js";import{A as we}from"./arrow-left-BLgX9Izv.js";import{T as U}from"./tag-DrPQXHlW.js";import{P as Ne}from"./plus-BX9PTZlR.js";import{B as ke}from"./bot-D5F5PHD0.js";import{F as Me}from"./flame-nXpsFzFy.js";import{C as Se}from"./check-JR3yIMwN.js";import{S as Te}from"./send-L2wUgW00.js";const Ce=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],X=v("archive",Ce);const Re=[["path",{d:"M12 18V5",key:"adv99a"}],["path",{d:"M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4",key:"1e3is1"}],["path",{d:"M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5",key:"1gqd8o"}],["path",{d:"M17.997 5.125a4 4 0 0 1 2.526 5.77",key:"iwvgf7"}],["path",{d:"M18 18a4 4 0 0 0 2-7.464",key:"efp6ie"}],["path",{d:"M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517",key:"1gq6am"}],["path",{d:"M6 18a4 4 0 0 1-2-7.464",key:"k1g0md"}],["path",{d:"M6.003 5.125a4 4 0 0 0-2.526 5.77",key:"q97ue3"}]],$e=v("brain",Re);const Ae=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Ee=v("eye-off",Ae);const qe=[["path",{d:"M4 22V4a1 1 0 0 1 .4-.8A6 6 0 0 1 8 2c3 0 5 2 7.333 2q2 0 3.067-.8A1 1 0 0 1 20 4v10a1 1 0 0 1-.4.8A6 6 0 0 1 16 16c-3 0-5-2-8-2a6 6 0 0 0-4 1.528",key:"1jaruq"}]],Le=v("flag",qe);const Ie=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],De=v("heart",Ie);const Oe=[["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}],["path",{d:"M7 10v12",key:"1qc93n"}]],He=v("thumbs-up",Oe);function Pe(d){return d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function Z(d){let s=Pe(d);return s=s.replace(/`([^`]+)`/g,'<code class="bg-[#111] px-1.5 py-0.5 rounded text-xs font-mono text-gray-200">$1</code>'),s=s.replace(/\*\*([^*]+)\*\*/g,'<strong class="font-semibold text-white">$1</strong>'),s=s.replace(/\*([^*]+)\*/g,'<em class="italic">$1</em>'),s=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="text-[#a6ed2a] hover:underline">$1</a>'),s=s.replace(/(^|[\s>])((https?:\/\/)[^\s<]+)/g,'$1<a href="$2" target="_blank" rel="noopener noreferrer" class="text-[#a6ed2a] hover:underline">$2</a>'),s}function Ve({content:d}){const s=i.useMemo(()=>{const c=[],m=d.split(/```(\w*)\n?([\s\S]*?)```/);for(let h=0;h<m.length;h++)h%3===0?m[h]&&c.push({type:"text",content:m[h]}):h%3===1||c.push({type:"code",content:m[h],lang:m[h-1]||void 0});return c},[d]);return e.jsx("div",{className:"text-sm text-gray-300 space-y-2",children:s.map((c,m)=>{if(c.type==="code")return e.jsx("pre",{className:"bg-[#111] rounded-lg p-3 overflow-x-auto text-xs font-mono text-gray-200 border border-[#1d2839]",children:e.jsx("code",{children:c.content})},m);const h=c.content.split(`
`),x=[];let g=[];const f=()=>{g.length>0&&(x.push(e.jsx("ul",{className:"list-disc list-inside space-y-0.5 pl-2",children:g.map((y,p)=>e.jsx("li",{dangerouslySetInnerHTML:{__html:Z(y)}},p))},`list-${x.length}`)),g=[])};for(const y of h){const p=y.match(/^[\s]*[-*]\s+(.+)/);if(p)g.push(p[1]);else{f();const u=y.trim();u&&x.push(e.jsx("p",{dangerouslySetInnerHTML:{__html:Z(u)}},`p-${x.length}`))}}return f(),e.jsx("div",{children:x},m)})})}const W=["Consensus reached","Question answered","Action items identified","Decision made","Information gathered","Other"];function Be({threadTitle:d,onResolve:s,onClose:c}){const[m,h]=i.useState(W[0]),[x,g]=i.useState(""),[f,y]=i.useState(!1);async function p(){x.trim()&&(y(!0),s({reason:m,summary:x.trim()}))}return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",onClick:c,children:e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-xl p-6 w-full max-w-md",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-[#a78bfa]"}),e.jsx("h2",{className:"text-lg font-bold",children:"Resolve Thread"})]}),e.jsx("button",{onClick:c,className:"text-gray-400 hover:text-white",children:e.jsx(ae,{className:"w-5 h-5"})})]}),e.jsxs("p",{className:"text-sm text-gray-400 mb-4",children:["Resolving: ",e.jsx("span",{className:"text-white",children:d})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Reason"}),e.jsx("select",{value:m,onChange:u=>h(u.target.value),className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-[#a78bfa]",children:W.map(u=>e.jsx("option",{value:u,children:u},u))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Resolution Summary"}),e.jsx("textarea",{value:x,onChange:u=>g(u.target.value),placeholder:"Summarize the resolution or key takeaways...",rows:4,className:"w-full bg-[#080c16] border border-[#1d2839] rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-[#a78bfa] text-sm resize-none"})]}),e.jsx("button",{onClick:p,disabled:!x.trim()||f,className:"w-full bg-[#a78bfa] text-white font-medium py-2 rounded-lg hover:bg-[#c4b5fd] transition-colors text-sm disabled:opacity-50",children:f?"Resolving...":"Resolve Thread"})]})]})})}const Y=[{emoji:"thumbsup",icon:He,label:"Thumbs up"},{emoji:"heart",icon:De,label:"Heart"},{emoji:"fire",icon:Me,label:"Fire"},{emoji:"thinking",icon:$e,label:"Thinking"},{emoji:"check",icon:Se,label:"Check"}],ee=50,te=100;function Fe(d){const s=Math.floor((Date.now()-new Date(d).getTime())/1e3);return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:`${Math.floor(s/86400)}d ago`}function We(){const{slug:d,threadId:s}=_e(),[c,m]=i.useState(null),[h,x]=i.useState(null),[g,f]=i.useState([]),[y,p]=i.useState([]),[u,re]=i.useState(!0),[l,L]=i.useState(null),[w,I]=i.useState(""),[ne,D]=i.useState(!1),[O,N]=i.useState(null),[k,ie]=i.useState([]),[j,H]=i.useState(!1),[P,oe]=i.useState([]),[M,V]=i.useState(""),[S,ce]=i.useState("custom"),[le,T]=i.useState(!1),[B,F]=i.useState(!1),[C,R]=i.useState(!1),z=i.useRef(null);i.useRef(null),i.useEffect(()=>{o.auth.getSession().then(({data:a})=>L(a.session));const{data:{subscription:t}}=o.auth.onAuthStateChange((a,r)=>L(r));return()=>t.unsubscribe()},[]),i.useEffect(()=>{s&&d&&_()},[s,d]),i.useEffect(()=>{if(!s)return;const t=o.channel(`thread-${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`thread_id=eq.${s}`},r=>{f(n=>[...n,r.new])}).subscribe(),a=o.channel(`reactions-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions"},()=>{K()}).subscribe();return()=>{o.removeChannel(t),o.removeChannel(a)}},[s]),i.useEffect(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[g]);async function _(){const{data:t}=await o.from("channels").select("slug, name").eq("slug",d).single();x(t);const{data:a}=await o.from("threads").select("*").eq("id",s).single();m(a);const{data:r,count:n}=await o.from("messages").select(`
        *,
        author:participants!messages_author_id_fkey(id, name, account_type)
      `,{count:"exact"}).eq("thread_id",s).order("created_at",{ascending:!1}).limit(te),b=(r||[]).reverse();f(b),F((n||0)>te),await K(),await $(),re(!1)}async function de(){if(!s||C||!B)return;R(!0);const t=g[0];if(!t){R(!1);return}const{data:a}=await o.from("messages").select(`
        *,
        author:participants!messages_author_id_fkey(id, name, account_type)
      `).eq("thread_id",s).lt("created_at",t.created_at).order("created_at",{ascending:!1}).limit(ee),r=(a||[]).reverse();f(n=>[...r,...n]),F(r.length===ee),R(!1)}async function $(){if(!s)return;const{data:t}=await o.from("thread_tags").select("*").eq("thread_id",s).order("created_at",{ascending:!0});ie(t||[])}async function he(){if(!s)return;const{data:t,error:a}=await o.rpc("suggest_thread_tags",{p_thread_id:s});!a&&t&&oe(t)}async function A(t,a){if(!s||!l||!a.trim())return;const{error:r}=await o.rpc("add_thread_tag",{p_thread_id:s,p_tag_type:t,p_tag_value:a.trim(),p_participant_id:l.user.id});r||(await $(),V(""),H(!1))}async function ue(t){const{error:a}=await o.from("thread_tags").delete().eq("id",t);a||await $()}async function me(){if(!s||!l||!c)return;if(c.status!=="open"){alert("Only open threads can be tagged");return}const{error:t}=await o.from("threads").update({status:"tagged"}).eq("id",s);t||await _()}async function xe(t){if(!s||!l||!c)return;if(c.status!=="tagged"){alert("Thread must be tagged before resolving");return}t?.summary&&await o.from("messages").insert({thread_id:s,author_id:l.user.id,content:`**Resolved:** ${t.reason}

${t.summary}`,type:"system"});const{error:a}=await o.from("threads").update({status:"resolved"}).eq("id",s);a||(T(!1),await _())}async function ge(){if(!s||!l)return;const{error:t}=await o.rpc("archive_thread",{p_thread_id:s});t||await _()}async function pe(){if(!s||!l||!c)return;if(c.status!=="resolved"){alert("Thread must be resolved before consolidating");return}const{data:t,error:a}=await o.rpc("consolidate_thread",{p_thread_id:s});!a&&t?(alert(`Artifact created: ${t}`),await _()):a&&alert(`Error: ${a.message}`)}async function fe(t){if(!l)return;const a=prompt("Reason for reporting:");a&&(await o.rpc("report_message",{p_message_id:t,p_reporter_id:l.user.id,p_reason:a}),alert("Message reported"))}async function ye(t){l&&(await o.rpc("moderate_hide_message",{p_message_id:t,p_moderator_id:l.user.id,p_reason:"Hidden by moderator"}),f(a=>a.map(r=>r.id===t?{...r,hidden:!0}:r)))}async function K(){if(!s)return;const{data:t}=await o.from("messages").select("id").eq("thread_id",s);if(!t||t.length===0){p([]);return}const{data:a}=await o.from("message_reactions").select("*").in("message_id",t.map(r=>r.id));p(a||[])}async function G(){!w.trim()||!l||!s||(D(!0),await o.from("messages").insert({thread_id:s,author_id:l.user.id,content:w.trim(),type:"text"}),I(""),D(!1))}async function J(t,a){if(!l)return;const r=y.find(n=>n.message_id===t&&n.participant_id===l.user.id&&n.emoji===a);if(r)await o.from("message_reactions").delete().eq("id",r.id),p(n=>n.filter(b=>b.id!==r.id));else{const{data:n}=await o.from("message_reactions").insert({message_id:t,participant_id:l.user.id,emoji:a}).select().single();n&&p(b=>[...b,n])}N(null)}function be(t){const a=y.filter(n=>n.message_id===t),r={};for(const n of a)r[n.emoji]||(r[n.emoji]={count:0,hasOwn:!1}),r[n.emoji].count++,l&&n.participant_id===l.user.id&&(r[n.emoji].hasOwn=!0);return r}return u?e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Loading..."}):!c||!h?e.jsx("div",{className:"text-center text-gray-500 py-12",children:"Thread not found"}):e.jsxs("div",{className:"flex flex-col h-[calc(100vh-10rem)]",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-shrink-0",children:[e.jsx(q,{to:`/channels/${d}`,className:"text-gray-400 hover:text-white",children:e.jsx(we,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-lg font-bold",children:c.title}),e.jsxs(q,{to:`/channels/${d}`,className:"text-xs text-gray-500 hover:text-[#a6ed2a]",children:["#",h.name]})]}),l&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{H(!j),j||he()},className:"text-gray-400 hover:text-white",title:"Manage tags",children:e.jsx(U,{className:"w-5 h-5"})}),c.status==="open"&&k.length>0&&e.jsx("button",{onClick:me,className:"text-gray-400 hover:text-[#60a5fa] transition-colors",title:"Mark as tagged",children:e.jsx(U,{className:"w-5 h-5 fill-current"})}),c.status==="tagged"&&e.jsx("button",{onClick:()=>T(!0),className:"text-gray-400 hover:text-[#a78bfa] transition-colors",title:"Resolve thread",children:e.jsx(se,{className:"w-5 h-5"})}),c.status==="resolved"&&e.jsx("button",{onClick:pe,className:"text-gray-400 hover:text-[#fb923c] transition-colors",title:"Consolidate into artifact",children:e.jsx(X,{className:"w-5 h-5"})}),c.status!=="archived"&&e.jsx("button",{onClick:ge,className:"text-gray-400 hover:text-gray-500 transition-colors",title:"Archive thread",children:e.jsx(X,{className:"w-4 h-4"})})]})]}),(k.length>0||j)&&e.jsxs("div",{className:"mb-4 flex-shrink-0",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[k.map(t=>e.jsxs("div",{className:"flex items-center gap-1 bg-[#0a101d] border border-[#1d2839] rounded-md px-2 py-1 text-xs",children:[e.jsx("span",{className:"text-gray-400",children:t.tag_value}),l&&t.created_by===l.user.id&&e.jsx("button",{onClick:()=>ue(t.id),className:"text-gray-600 hover:text-red-400",children:e.jsx(ae,{className:"w-3 h-3"})})]},t.id)),j&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("select",{value:S,onChange:t=>ce(t.target.value),className:"bg-[#080c16] border border-[#1d2839] rounded-md px-2 py-1 text-xs text-white",children:[e.jsx("option",{value:"dimension",children:"Dimension"}),e.jsx("option",{value:"topic",children:"Topic"}),e.jsx("option",{value:"artifact_type",children:"Artifact Type"}),e.jsx("option",{value:"custom",children:"Custom"})]}),e.jsx("input",{value:M,onChange:t=>V(t.target.value),onKeyDown:t=>t.key==="Enter"&&A(S,M),placeholder:"Tag value...",className:"bg-[#080c16] border border-[#1d2839] rounded-md px-2 py-1 text-xs text-white placeholder-gray-600"}),e.jsx("button",{onClick:()=>A(S,M),className:"bg-[#a6ed2a] text-[#080c16] rounded-md p-1",children:e.jsx(Ne,{className:"w-4 h-4"})})]})]}),j&&P.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-[#1d2839]",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Suggested:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:P.slice(0,5).map((t,a)=>e.jsx("button",{onClick:()=>A(t.tag_type,t.tag_value),className:"text-xs px-2 py-1 rounded-md bg-[#080c16] text-gray-400 border border-[#1d2839] hover:border-[#a6ed2a] hover:text-white transition-colors",children:t.tag_value},a))})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 mb-4",children:[B&&e.jsx("div",{className:"text-center py-2",children:e.jsx("button",{onClick:de,disabled:C,className:"text-sm text-[#a6ed2a] hover:text-[#b8f247] disabled:opacity-50",children:C?"Loading...":"Load earlier messages"})}),g.length===0?e.jsx("div",{className:"text-center text-gray-500 py-12 text-sm",children:"No messages yet. Start the conversation!"}):g.map(t=>{const a=t.type==="system",r=be(t.id);return e.jsx("div",{className:`group relative ${a?"text-center":""}`,onMouseLeave:()=>N(null),children:a?e.jsx("div",{className:"inline-block bg-[#1d2839] rounded-lg px-4 py-2 text-xs text-gray-400 italic",children:t.content}):t.hidden?e.jsx("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-2 opacity-50",children:e.jsx("span",{className:"text-xs text-gray-500 italic",children:"Message hidden by moderator"})}):e.jsxs("div",{className:"bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-white",children:t.author?.name||(t.author_id?t.author_id.slice(0,8):"Anonymous")}),t.author?.account_type==="agent"&&e.jsxs("span",{className:"inline-flex items-center gap-1 bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded text-xs",children:[e.jsx(ke,{className:"w-3 h-3"}),"Agent"]}),e.jsx("span",{className:"text-xs text-gray-600",children:Fe(t.created_at)}),l&&e.jsxs("div",{className:"ml-auto flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:()=>N(O===t.id?null:t.id),className:"text-gray-600 hover:text-gray-400 text-xs",children:"+"}),e.jsx("button",{onClick:()=>fe(t.id),className:"text-gray-600 hover:text-red-400 text-xs",title:"Report",children:e.jsx(Le,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>ye(t.id),className:"text-gray-600 hover:text-yellow-400 text-xs",title:"Hide",children:e.jsx(Ee,{className:"w-3 h-3"})})]})]}),e.jsx(Ve,{content:t.content}),Object.keys(r).length>0&&e.jsx("div",{className:"flex gap-1.5 mt-2 flex-wrap",children:Object.entries(r).map(([n,{count:b,hasOwn:E}])=>{const Q=Y.find(je=>je.emoji===n);if(!Q)return null;const ve=Q.icon;return e.jsxs("button",{onClick:()=>J(t.id,n),className:`flex items-center gap-1 px-2 py-0.5 rounded-full text-xs border transition-colors ${E?"border-[#a6ed2a]/40 bg-[#a6ed2a]/10 text-[#a6ed2a]":"border-[#1d2839] bg-[#1d2839]/50 text-gray-400 hover:border-gray-500"}`,children:[e.jsx(ve,{className:"w-3 h-3"}),b]},n)})}),O===t.id&&e.jsx("div",{className:"flex gap-1 mt-2 bg-[#1d2839] rounded-lg p-1.5 w-fit",children:Y.map(({emoji:n,icon:b,label:E})=>e.jsx("button",{onClick:()=>J(t.id,n),title:E,className:"p-1.5 rounded hover:bg-[#333] text-gray-400 hover:text-white transition-colors",children:e.jsx(b,{className:"w-4 h-4"})},n))})]})},t.id)}),e.jsx("div",{ref:z})]}),l?e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx("input",{value:w,onChange:t=>I(t.target.value),onKeyDown:t=>t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),G()),placeholder:"Type a message...",className:"flex-1 bg-[#0a101d] border border-[#1d2839] rounded-lg px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:border-[#a6ed2a] text-sm"}),e.jsx("button",{onClick:G,disabled:!w.trim()||ne,className:"bg-[#a6ed2a] text-[#080c16] px-4 py-2.5 rounded-lg hover:bg-[#b8f247] transition-colors disabled:opacity-50",children:e.jsx(Te,{className:"w-4 h-4"})})]}):e.jsxs("div",{className:"text-center py-3 text-sm text-gray-500",children:[e.jsx(q,{to:"/auth",className:"text-[#a6ed2a] hover:text-white",children:"Sign in"})," to send messages"]}),le&&c&&e.jsx(Be,{threadTitle:c.title,onResolve:xe,onClose:()=>T(!1)})]})}export{We as ThreadView};
